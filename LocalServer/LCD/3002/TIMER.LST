8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    12:05:03  11/27/;3  PAGE    1


DOS 5.0 (038-N) 8086/87/88/186 MACRO ASSEMBLER V3.1 ASSEMBLY OF MODULE TIMER
OBJECT MODULE PLACED IN TIMER.OBJ
ASSEMBLER INVOKED BY:  C:\ASM86.EXE TIMER.ASM


LOC  OBJ                  LINE     SOURCE

                             1 +1  $MOD186
                             2 +1  $EP
                             3     NAME TIMER
                             4     ; Main program for uPD70208 microcomputer system
                             5     ;
                             6     ; Author:       Dr Tay Teng Tiow
                             7     ; Address:      Department of Electrical Engineering 
                             8     ;               National University of Singapore
                             9     ;               10, Kent Ridge Crescent
                            10     ;               Singapore 0511. 
                            11     ; Date:         6th September 1991
                            12     ;
                            13     ; This file contains proprietory information and cannot be copied 
                            14     ; or distributed without prior permission from the author.
                            15     ; =========================================================================
                            16     
                            17     public  serial_rec_action, timer2_action
                            18     extrn   print_char:far, print_2hex:far, iodefine:far, CMD_WRITE:far,delay:far, DATA_W
                                   RITE: far
                            19     extrn   set_timer2:far
                            20     
----                        21     STACK_SEG       SEGMENT
0000 (256                   22                     DB      256 DUP(?)
     ??
     )
0100                        23             TOS     LABEL   WORD
----                        24     STACK_SEG       ENDS
                            25     
                            26     
----                        27     DATA_SEG        SEGMENT
0000 0A                     28             TIMER0_MESS     DB      10,13,'TIMER1 INTERRUPT    '
0001 0D
0002 54494D45523120
     494E5445525255
     505420202020
0016 2F                     29             T_COUNT         DB      2FH
0017 2F                     30             T_COUNT_SET     DB      2FH
0018 20                     31             REC_MESS        DB      ''
0019 20                     32             DISPLAY_BUFF DB ''
001A 426172636F6465         33             D1                      DB      'Barcode :'
     203A
0023 313233343536           34             D2                      DB      '123456'  
0029 50726963652020         35             D3                      DB      'Price   :$'  
     203A24
0033 3232352E35             36             D4                      DB      '225.5'   
----                        37     DATA_SEG        ENDS
                            38     
                            39 +1  $include(80188.inc)
                      =1    40     ;IO Setup for 80C188XL 
                      =1    41     ;By Zhu Shunyu
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    12:05:03  11/27/;3  PAGE    2


LOC  OBJ                  LINE     SOURCE

                      =1    42     
  FFA0                =1    43              UMCR    EQU    0FFA0H ; Upper Memory Control Register
  FFA2                =1    44              LMCR    EQU    0FFA2H ; Lower Memory control Register         
  FFA4                =1    45              PCSBA   EQU    0FFA4H ; Peripheral Chip Select Base Address
  FFA6                =1    46                      MMCS    EQU    0FFA6H ; MMCS           
  FFA8                =1    47              MPCS    EQU    0FFA8H ; MMCS and PCS Alter Control Register
  0080                =1    48                     PORTA EQU 80H ;Port A
  0081                =1    49                     PORTB EQU 081H ;Port B
  0082                =1    50                     PORTC EQU 082H ;Port C
  0083                =1    51                     CWR EQU 83H ;Command Word Register
                      =1    52     
                      =1    53     
                      =1    54     
                      =1    55     ; Initial 80C188XL UCS Pin
                      =1    56     ; |start address|block size| value for No waits, No Ready   
                      =1    57     ;   FE000H            8K                 3E04H
                      =1    58     ;   FC000H           16K                 3C04H
                      =1    59     ;   F8000H           32K                 3804H
                      =1    60      
                      =1    61              
                      =1    62     ; Initialize Upper Chip Select pin with 8K ROM 
0000 BAA0FF           =1    63              MOV DX, UMCR
0003 B8043E           =1    64              MOV AX, 03E04H
0006 EE               =1    65              OUT DX, AL
                      =1    66     
                      =1    67     ; Initialize Lower Chip Select pin with 8k RAM
0007 BAA2FF           =1    68              MOV DX, LMCR
000A B8C401           =1    69              MOV AX, 01C4H  ; Starting address 1FFFH, 8K, No waits, last shoud be 5H for 
                                   1 waits      
000D EE               =1    70              OUT DX, AL
                      =1    71     ; Initialize MPCS to MAP peripheral to IO address
000E BAA8FF           =1    72              MOV DX, MPCS
0011 B88320           =1    73              MOV AX, 02083H
0014 EE               =1    74              OUT DX, AL
                      =1    75     ;INITIALISE MMCS
0015 BAA6FF           =1    76                     MOV DX, MMCS
0018 B80340           =1    77                     MOV AX, 04003H
001B EE               =1    78                     OUT DX, AL
                      =1    79     ; PCSBA initial, set the serial port start from 00H
001C BAA4FF           =1    80              MOV DX, PCSBA
001F B80300           =1    81              MOV AX, 0003H ; Peripheral starting address 00H no READY, No Waits
0022 EE               =1    82              OUT DX, AL
                      =1    83     
                      =1    84     ;Serial port definition and initialize 
  0000                =1    85              SRB     EQU       00H ; Serial Receiver Buffer Register (R)
  0000                =1    86              STB     EQU       00H ; Serial Transmitter Holding Register(W)  
  0001                =1    87              SIER    EQU       01H ; Serial Interrupte Enable Register (w)
  0002                =1    88              IIR     EQU       02H ; Interrupt Identification Register (R)
  0003                =1    89              SMD     EQU       03H ; Serial Line Control Register
  0005                =1    90              SST     EQU       05H ; Serial Line Status Register
  0000                =1    91              DLL     EQU       00H ; Divisor Latch Least Significant BYTE
  0001                =1    92              DLM     EQU       01H ; Divisor Latch most  Significant BYTE
                      =1    93     
                      =1    94     ;Definition of content of SST register
                      =1    95     ;|Not Use|TE|THRE|BI|FE|PE|OE|DR|
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    12:05:03  11/27/;3  PAGE    3


LOC  OBJ                  LINE     SOURCE

                      =1    96     ;TE Transmitter empty
                      =1    97     ;THRE Transmittor Holding Register Empty
                      =1    98     ;BI Breakr Interrupt
                      =1    99     ;FE Framing Error
                      =1   100     ;PE Parity Error
                      =1   101     ;OE Overrun Error 
                      =1   102     ;DR Data Ready
  0001                =1   103               REC_RDY    EQU   00000001B
  0020                =1   104               TRAN_RDY   EQU   00100000B
  000E                =1   105               ERR_DET    EQU   00001110B
  0010                =1   106               BREAK_DET  EQU   00010000B
                      =1   107     ; Serial Line Control Data
  0007                =1   108             SMD_DATA     EQU    00000111B
  0003                =1   109             S_INT_ENA    EQU    00000011B
  0000                =1   110             S_INT_DIS    EQU    00000000B
                      =1   111        
                      =1   112     ;1st bit set 1 to access the Divisor latch 
                      =1   113     ;2 stop bits, 8 data bits, no parity check
  0087                =1   114             SMD_DATA_DIV EQU    10000111B
                      =1   115     ; Set divisor value        
0023 BA0300           =1   116             MOV DX, SMD
0026 B087             =1   117             MOV AL, SMD_DATA_DIV
0028 EE               =1   118             OUT DX, AL
0029 BA0000           =1   119             MOV DX, DLL
002C B034             =1   120             MOV AL, 52
002E EE               =1   121             OUT DX, AL
002F BA0100           =1   122             MOV DX, DLM
0032 B000             =1   123             MOV AL, 0
0034 EE               =1   124             OUT DX, AL
                      =1   125     ;SET SERIAL PORT WORKING MODE
0035 BA0300           =1   126              MOV DX, SMD
0038 B007             =1   127              MOV AL, SMD_DATA
003A EE               =1   128              OUT DX, AL
                      =1   129     ;DISABLE SERIAL PORT INT
003B BA0100           =1   130              MOV DX, SIER
003E B000             =1   131              MOV AL, 0
0040 EE               =1   132              OUT DX, AL
                      =1   133     
                      =1   134     
                      =1   135     
                      =1   136     ; Timer control Unit
                      =1   137       
  FF66                =1   138              T2_CON    EQU      0FF66H ; Timer 2 Control Register
  FF62                =1   139              T2_CA     EQU      0FF62H ; Timer 2 compare register
  FF60                =1   140              T2_CNT    EQU      0FF60H ;
                      =1   141     
  FF5E                =1   142              T1_CON    EQU      0FF5EH ;
  FF5C                =1   143              T1_CB     EQU      0FF5CH ;
  FF5A                =1   144              T1_CA     EQU      0FF5AH ;
  FF58                =1   145              T1_CNT    EQU      0FF58H
                      =1   146              
  FF56                =1   147              T0_CON    EQU      0FF56H ;
  FF54                =1   148              T0_CB     EQU      0FF54H ;
  FF52                =1   149              T0_CA     EQU      0FF52H ;
  FF50                =1   150              TO_CNT    EQU      0FF50H   
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    12:05:03  11/27/;3  PAGE    4


LOC  OBJ                  LINE     SOURCE

                      =1   151              
                      =1   152     ; Timer Control Data
                      =1   153     
                      =1   154     
                      =1   155     ;Interrupt Control Registers
                      =1   156           
                      =1   157     
  FF3E                =1   158             INT3_CTRL       EQU 0FF3EH ;Interrupt 3 Control Register
  FF3C                =1   159             INT2_CTRL       EQU 0FF3CH
  FF3A                =1   160             INT1_CTRL       EQU 0FF3AH
  FF38                =1   161             INT0_CTRL       EQU 0FF38H
  FF32                =1   162             TIMER_CTRL      EQU 0FF32H ;Timer Interrupt Control Register
  FF30                =1   163             ISR             EQU 0FF30H ; Interrupt Status Register
  FF22                =1   164             EOI             EQU 0FF22H ; END OF INTERRUPT REGISTER
                      =1   165             
  FF28                =1   166             IMKW            EQU 0FF28H ; Interrupt Mask 
  FF2A                =1   167             IPMK            EQU 0FF2Ah ; Interrupt Priority Mask 
                      =1   168     
                      =1   169     ;| - | - | - | - |MSK|PM2|PM1|PM0| For TCU INT
                      =1   170     
                      =1   171     ;| - |SFNM|CAS|LVL|MSK|PM2|PM1|PM0| For TCU INT0,1
                      =1   172     
                      =1   173     ;MSK 1-enable, 0-mask int 
                      =1   174     ;pm0-pm1 Priority
                      =1   175     
                      =1   176         
                           177     
----                       178     CODE_SEG        SEGMENT
                           179     
                           180             PUBLIC          START
                           181     
                           182     
                           183     ASSUME  CS:CODE_SEG, SS:STACK_SEG
                           184     
0000                       185     START:
                           186     
                           187     ;initialize stack area
0000 B8----         R      188                     MOV     AX,STACK_SEG            
0003 8ED0                  189                     MOV     SS,AX
0005 368B260001            190                     MOV     SP,TOS
                           191     
                           192     ; Initialize the on-chip pheripherals
000A 9A0000----     E      193                     CALL    FAR PTR IODEFINE
                           194                     
                           195     
                           196     
                           197     ; ^^^^^^^^^^^^^^^^^  Start of User Main Routine  ^^^^^^^^^^^^^^^^^^
000F 9A0000----     E      198                     call set_timer2
0014 FB                    199             STI
                           200                     ;START OF LCD ROUTINE
0015 BA8300                201                     MOV DX, 83H
0018 B88000                202                     MOV AX, 080H
001B EF                    203                     OUT DX, AX
001C 9A0000----     E      204                     CALL FAR PTR DELAY
                           205                     
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    12:05:03  11/27/;3  PAGE    5


LOC  OBJ                  LINE     SOURCE

0021 B038                  206                     MOV AL, 38H ; Set function set
0023 9A0000----     E      207                     CALL FAR PTR CMD_WRITE
0028 9A0000----     E      208                     CALL FAR PTR DELAY
002D 9A0000----     E      209                     CALL FAR PTR DELAY
0032 9A0000----     E      210                     CALL FAR PTR DELAY
                           211                     
0037 B008                  212                     MOV AL, 08H ;Switch off display
0039 9A0000----     E      213                     CALL FAR PTR CMD_WRITE
003E 9A0000----     E      214                     CALL FAR PTR DELAY
                           215                     
0043 B001                  216                     MOV AL, 01H ;Clear lcd
0045 9A0000----     E      217                     CALL FAR PTR CMD_WRITE
004A 9A0000----     E      218                     CALL FAR PTR DELAY
                           219                     
004F B006                  220                     MOV AL, 06H ;Set entry mode register
0051 9A0000----     E      221                     CALL FAR PTR CMD_WRITE
0056 9A0000----     E      222                     CALL FAR PTR DELAY
                           223                     
005B B00F                  224                     MOV AL, 0FH ;Set display on, cursor on, and blinking
005D 9A0000----     E      225                     CALL FAR PTR CMD_WRITE
0062 9A0000----     E      226                     CALL FAR PTR DELAY
                           227                             
                           228                     
0067 B90900                229                     MOV CX, 9H
006A BB----         R      230                     MOV BX, DATA_SEG
006D 8EDB                  231                     MOV DS, BX
006F BB0000                232                     MOV BX, 0H
                           233                     
                           234     ; PRINTMSG:
                           235                     ; MOV AL, DS:D1[BX]
                           236                     ; CALL FAR PTR DATA_WRITE
                           237                     ; CALL FAR PTR DELAY
                           238                     ; INC BX
                           239                     ; LOOP PRINTMSG
                           240                     
                           241                     ; MOV CX, 6H
                           242                     ; MOV BX, 0H
                           243                     
                           244     ; PRINTBARCODE:
                           245                     ; MOV AL, DS:D2[BX]
                           246                     ; CALL FAR PTR DATA_WRITE
                           247                     ; CALL FAR PTR DELAY
                           248                     ; INC BX
                           249                     ; LOOP PRINTBARCODE             
                           250             
                           251                     ; MOV AL, 0C0H ;Set DDRAM Address to Next Line
                           252                     ; CALL FAR PTR CMD_WRITE
                           253                     ; CALL FAR PTR DELAY
                           254                     
                           255                     ; MOV CX, 0AH
                           256                     ; MOV BX, DATA_SEG
                           257                     ; MOV DS, BX
                           258                     ; MOV BX, 0H
                           259     ; PRINTNEXTLINE:
                           260                     ; MOV AL, DS:D3[BX]
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    12:05:03  11/27/;3  PAGE    6


LOC  OBJ                  LINE     SOURCE

                           261                     ; CALL FAR PTR DATA_WRITE
                           262                     ; CALL FAR PTR DELAY
                           263                     ; INC BX
                           264                     ; LOOP PRINTNEXTLINE
                           265                     
                           266                     ; MOV CX, 6H
                           267                     ; MOV BX, 0H
                           268                     
                           269     ; PRINTPRICE:
                           270                     ; MOV AL, DS:D4[BX]
                           271                     ; CALL FAR PTR DATA_WRITE
                           272                     ; CALL FAR PTR DELAY
                           273                     ; INC BX
                           274                     ; LOOP PRINTPRICE       
                           275                     
                           276     
                           277                     
0072 B001                  278                     MOV AL, 01H ;Clear lcd
0074 9A0000----     E      279                     CALL FAR PTR CMD_WRITE
0079 9A0000----     E      280                     CALL FAR PTR DELAY
                           281                     
                           282                     
007E EBFE                  283     NEXT:     JMP NEXT
                           284     
                           285     ; ^^^^^^^^^^^^^^^ End of User main routine ^^^^^^^^^^^^^^^^^^^^^^^^^
                           286     
                           287     
0080                       288     SERIAL_REC_ACTION       PROC    FAR
0080 51                    289                     PUSH    CX
0081 53                    290                     PUSH    BX
0082 1E                    291                     PUSH    DS
                           292     
0083 BB----         R      293                     MOV     BX,DATA_SEG             ;initialize data segment register
0086 8EDB                  294                     MOV     DS,BX
                           295                                     
0088 A21800                296                     MOV DS:REC_MESS, AL
008B 9A0000----     E      297                 CALL  FAR PTR print_char
                           298                     
                           299                     ;START OF LCD ROUTINE
0090 BA8300                300                     MOV DX, 83H
0093 B88000                301                     MOV AX, 080H
0096 EF                    302                     OUT DX, AX
0097 9A0000----     E      303                     CALL FAR PTR DELAY
                           304                     
009C B006                  305                     MOV AL, 06H ;Set entry mode register
009E 9A0000----     E      306                     CALL FAR PTR CMD_WRITE
00A3 9A0000----     E      307                     CALL FAR PTR DELAY
                           308                     
00A8 B00F                  309                     MOV AL, 0FH ;Set display on, cursor on, and blinking
00AA 9A0000----     E      310                     CALL FAR PTR CMD_WRITE
00AF 9A0000----     E      311                     CALL FAR PTR DELAY
                           312                             
                           313                     
00B4 B90100                314                     MOV CX, 1H
00B7 BB----         R      315                     MOV BX, DATA_SEG
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    12:05:03  11/27/;3  PAGE    7


LOC  OBJ                  LINE     SOURCE

00BA 8EDB                  316                     MOV DS, BX
00BC BB0000                317                     MOV BX, 0H
                           318                     
00BF 8A4718                319             MOV AL, DS:REC_MESS[BX]
00C2 3C5A                  320                     CMP AL, 'Z'
00C4 740A                  321                     JE CHECK_DISPLAY
00C6 7500                  322                     JNE PRINT
                           323     
00C8                       324     PRINT:          
00C8 9A0000----     E      325            CALL FAR PTR PRINT_CHAR
00CD EB6C90                326                JMP S_RET
                           327                     
00D0                       328     CHECK_DISPLAY:
00D0 43                    329                     INC BX
00D1 8A4718                330                     MOV AL, DS:REC_MESS[BX]
00D4 9A0000----     E      331                     CALL  FAR PTR print_char
00D9 A21900                332                     MOV DS:DISPLAY_BUFF, AL
00DC 3C58                  333                     CMP AL, 'X'
00DE 7402                  334                     JE DONE_DISPLAY
00E0 E2EE                  335             LOOP CHECK_DISPLAY
                           336                     
00E2                       337     DONE_DISPLAY:
00E2 53                    338             PUSH BX
00E3 33DB                  339                     XOR BX, BX
00E5 8A4719                340                     MOV AL, DS:DISPLAY_BUFF[BX]
00E8 3C01                  341                     CMP AL,1
00EA 752A                  342                     JNE DONT_DISPLAY
00EC 43                    343                     INC BX
00ED 8A4719                344                     MOV AL, DS:DISPLAY_BUFF[BX]
00F0 3C01                  345                     CMP AL,1
00F2 7522                  346                     JNE DONT_DISPLAY
00F4 43                    347                     INC BX
00F5 8A4719                348                     MOV AL, DS:DISPLAY_BUFF[BX]
00F8 3C01                  349                     CMP AL,1
00FA 751A                  350                     JNE DONT_DISPLAY
00FC 43                    351                     INC BX
00FD 8A4719                352                     MOV AL, DS:DISPLAY_BUFF[BX]
0100 3C01                  353                     CMP AL,1
0102 7512                  354                     JNE DONT_DISPLAY
0104 43                    355                     INC BX
0105 8A4719                356                     MOV AL, DS:DISPLAY_BUFF[BX]
0108 3C2A                  357                     CMP AL,'*'
                           358                     
010A 5B                    359                     POP BX
010B 7509                  360                     JNE DONT_DISPLAY
010D EB0190                361                     JMP DISPLAY
                           362     
0110                       363     DISPLAY:
0110 3C3A                  364                     CMP AL, ':'
0112 7405                  365                     JE MOV_NEXT_LINE
0114 750F                  366                     JNE PRINTMSG1   
                           367                     
0116                       368     DONT_DISPLAY:
0116 EB2390                369                     JMP S_RET
                           370                             
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    12:05:03  11/27/;3  PAGE    8


LOC  OBJ                  LINE     SOURCE

                           371             
0119                       372     MOV_NEXT_LINE:
                           373                     
0119 B0C0                  374                     MOV AL, 0C0H ;Set DDRAM Address to Next Line
011B 9A0000----     E      375                     CALL FAR PTR CMD_WRITE
0120 9A0000----     E      376                     CALL FAR PTR DELAY
                           377                     
                           378                     
0125                       379     PRINTMSG1:
0125 8A4718                380                     MOV AL, DS:REC_MESS[BX]
0128 9A0000----     E      381                     CALL FAR PTR DATA_WRITE
012D 9A0000----     E      382                     CALL FAR PTR DELAY
0132 43                    383                     INC BX
0133 E2F0                  384                     LOOP PRINTMSG1
                           385                     
0135 B90600                386                     MOV CX, 6H
0138 BB0000                387                     MOV BX, 0H
                           388                     
013B                       389     S_RET:
013B 1F                    390                     POP     DS
013C 5B                    391                     POP     BX
013D 59                    392                     POP     CX
013E CB                    393                     RET
                           394     SERIAL_REC_ACTION       ENDP
                           395     
                           396     
                           397     
013F                       398     TIMER2_ACTION   PROC    FAR
013F 50                    399                     PUSH    AX
0140 1E                    400                     PUSH    DS
0141 53                    401                     PUSH    BX
0142 51                    402                     PUSH    CX
                           403     
0143 B8----         R      404                     MOV     AX,DATA_SEG
0146 8ED8                  405                     MOV     DS,AX
                           406                     
0148 FE0E1600              407                     DEC     DS:T_COUNT
014C 7516                  408                     JNZ     T_NEXT1
014E A01700                409                     MOV     AL,DS:T_COUNT_SET
0151 A21600                410                     MOV     DS:T_COUNT,AL
                           411                     
                           412                     ; PUSH AX
                           413                     ; MOV AL, 18H ;set entry mode register
                           414                     ; CALL FAR PTR CMD_WRITE
                           415                     ; CALL FAR PTR DELAY
                           416                     ; POP AX
                           417                     ;MOV DX, 180H
                           418                     ;OUT DX, 0FFH
                           419                     
                           420                     ;MOV DX, 200H
                           421                     ;OUT DX, 0FFH
                           422                     
0154 B91400                423                     MOV     CX,20
0157 BB0000                424                     MOV     BX,0H
015A                       425     T_NEXT0:
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    12:05:03  11/27/;3  PAGE    9


LOC  OBJ                  LINE     SOURCE

015A 8A07                  426                     MOV     AL,DS:TIMER0_MESS[BX]
015C 43                    427                     INC     BX
015D 9A0000----     E      428                     CALL    FAR PTR PRINT_CHAR
0162 E2F6                  429                     LOOP    T_NEXT0
                           430     
0164                       431     T_NEXT1:        
0164 59                    432                     POP     CX
0165 5B                    433                     POP     BX
0166 1F                    434                     POP     DS
0167 58                    435                     POP     AX
0168 CB                    436                     RET
                           437     TIMER2_ACTION   ENDP
                           438     
                           439     
----                       440     CODE_SEG        ENDS
                           441     END

ASSEMBLY COMPLETE, NO ERRORS FOUND
